language: cpp

os:
  - linux
  - osx

sudo: required
dist: trusty

compiler:
  - gcc
  - clang

script: make

matrix:
  exclude:
  - os: osx
    compiler: gcc
  - os: linux
    compiler: clang

before_install:
  - TAGAINI_VERSION=`grep "set(VERSION" CMakeLists.txt | cut -d ' ' -f 2 | tr -d '\)'`
  - export TAGAINI_VERSION
  - env | sort
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo add-apt-repository ppa:beineri/opt-qt551-trusty -y ; sudo apt-get -qq update ; sudo apt-get install -qq libtext-multimarkdown-perl sqlite3 rpm qt55base qt55websockets qt55translations qt55tools; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew update ; brew install multimarkdown qt5; fi

before_script:
  - mkdir build
  - cd build
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then source /opt/qt55/bin/qt55-env.sh ; cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DEMBED_SQLITE=1 ..; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then cmake -DCMAKE_PREFIX_PATH=`brew --prefix qt5` -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DEMBED_SQLITE=1 ..; fi

after_success:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then ../pack/source/buildsourcerelease.sh ; cpack -G DEB ; cpack -G RPM ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then sudo -s -- "cpack -G DragNDrop" ; sudo -s -- "chown travis Tagaini\ Jisho-$TAGAINI_VERSION.dmg " ; fi

deploy:
  - provider: releases
    skip_cleanup: true
    api_key:
      secure: N/wOTfrlb4TxMVHSjUkfX5AnJqlOnTMVPYYf22/AnOU1ecA5r45hF+3Q6rA1UUCf4My/cPCWRaxmKvgZIg3rTCvTZM43JxuUuqqYcmCzrQnnPtiV+CXutPQC2s3Y+Kkecbv+XApPq8D2RMYcw/aiz/dv/KRMoVM2jGZODyqAe9E=
    file:
      - tagainijisho-$TAGAINI_VERSION.tar.gz
      - tagainijisho-$TAGAINI_VERSION.deb
      - tagainijisho-$TAGAINI_VERSION.rpm
    on:
      tags: true
      all_branches: true
      condition: $TRAVIS_OS_NAME = linux
  - provider: releases
    skip_cleanup: true
    api_key:
      secure: N/wOTfrlb4TxMVHSjUkfX5AnJqlOnTMVPYYf22/AnOU1ecA5r45hF+3Q6rA1UUCf4My/cPCWRaxmKvgZIg3rTCvTZM43JxuUuqqYcmCzrQnnPtiV+CXutPQC2s3Y+Kkecbv+XApPq8D2RMYcw/aiz/dv/KRMoVM2jGZODyqAe9E=
    file:
      - "Tagaini Jisho-$TAGAINI_VERSION.dmg"
    on:
      tags: true
      all_branches: true
      condition: $TRAVIS_OS_NAME = osx

